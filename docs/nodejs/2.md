
# npm run 的原理

npm run 命令会读取项目根目录下 package.json 文件中的 "scripts" 字段。这个字段定义了可以执行的脚本命令：

```json
{
  "scripts": {
    "start": "node server.js",
    "build": "webpack --mode=production",
    "test": "jest",
    "dev": "nodemon app.js"
  }
}
```

## 命令执行流程

当你运行 `npm run <script-name>` 时，npm 会按以下步骤执行：

**查找脚本**：npm 在 package.json 的 scripts 字段中查找指定的脚本名称。


**环境变量设置**：npm 会设置一些特殊的环境变量，包括将 目录添加到 PATH 中，这样就可以直接调用本地安装的包的可执行文件。

**Shell 执行**：npm 使用系统的 shell（在 Unix 系统上通常是 /bin/sh，在 Windows 上是 cmd.exe）来执行脚本命令。

-   先从当前项目的 `node_modules/.bin`去查找可执行命令
-   如果没找到就去全局的 `node_modules`去找可执行命令
-   如果还没找到就去环境变量查找
-   再找不到就进行报错

nodejs 是跨平台的所以可执行命令兼容各个平台,找到会有三个可执行文件

- .sh文件是给Linux unix Macos 使用
- .cmd 给windows的cmd使用
- .ps1 给windows的powerShell 使用

## PATH 环境变量的关键作用

这是 npm run 最重要的特性之一。当脚本执行时，npm 会临时修改 PATH 环境变量，将项目的 `node_modules/.bin` 目录添加到 PATH 的开头。这意味着：

- 你可以直接使用本地安装的包的命令，而不需要完整路径
- 例如，如果你本地安装了 webpack，可以在脚本中直接写 "webpack"，而不是 "./node_modules/.bin/webpack"

## 生命周期钩子

npm 还支持生命周期钩子，会自动执行 pre 和 post 脚本：

- 运行 `npm run build` 时，如果存在 `prebuild` 脚本会先执行
- build 脚本执行完毕后，如果存在 `postbuild` 脚本会接着执行

## 参数传递

可以通过 `--` 向脚本传递额外参数：

```bash
npm run test -- --coverage
```

这会将 `--coverage` 参数传递给实际的测试命令。

npm run 的基本工作原理本质上是一个脚本执行器，通过修改环境变量和利用 shell 来执行定义在 package.json 中的命令。